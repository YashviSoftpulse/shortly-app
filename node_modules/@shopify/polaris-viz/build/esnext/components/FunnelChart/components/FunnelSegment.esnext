import { useRef, Fragment } from 'react';
import { createPortal } from 'react-dom';
import { useSpring, animated, to } from '@react-spring/web';
import { useTheme, getRoundedRectPath, changeColorOpacity } from '@shopify/polaris-viz-core';
import { useBarSpringConfig } from '../../../hooks/useBarSpringConfig.esnext';
import { Label } from './Label.esnext';
import { jsxs, jsx } from 'react/jsx-runtime';

const Y_AXIS_LABEL_VERTICAL_OFFSET = 32;
const PERCENT_LABEL_VERTICAL_OFFSET = 24;
function FunnelSegment({
  barWidth,
  barHeight,
  drawableHeight,
  x,
  ariaLabel,
  index = 0,
  color,
  connector,
  isLast,
  portalTo,
  percentLabel,
  formattedYValue,
  labelHelper
}) {
  const selectedTheme = useTheme();
  const mounted = useRef(false);
  const borderRadius = selectedTheme.bar.borderRadius;
  const {
    xAxis: {
      labelColor: axisLabelColor
    },
    chartContainer: {
      backgroundColor
    }
  } = useTheme();
  const springConfig = useBarSpringConfig({
    animationDelay: index * 150
  });
  const {
    animatedHeight,
    animatedStartY,
    animatedNextY
  } = useSpring({
    from: {
      animatedHeight: mounted.current ? barHeight : 0,
      animatedStartY: drawableHeight,
      animatedNextY: drawableHeight
    },
    to: {
      animatedHeight: barHeight,
      animatedStartY: connector.startY,
      animatedNextY: connector.nextY
    },
    ...springConfig
  });
  return /*#__PURE__*/jsxs(Fragment, {
    children: [/*#__PURE__*/createPortal( /*#__PURE__*/jsx(animated.path, {
      "aria-label": ariaLabel,
      fill: color,
      width: barWidth,
      d: animatedHeight.to(value => getRoundedRectPath({
        height: value,
        width: barWidth,
        borderRadius: `${borderRadius} ${borderRadius} 0 0`
      })),
      style: {
        transform: animatedHeight.to(value => `translate(${x}px, ${drawableHeight - value}px)`)
      }
    }), portalTo), !isLast && /*#__PURE__*/jsx(animated.path, {
      d: to([animatedStartY, animatedNextY, animatedHeight], (startY, nextY) => `M${connector.startX} ${startY}
               L ${connector.nextX} ${nextY}
               V ${connector.height} H ${connector.startX} Z`),
      fill: connector.fill
    }), /*#__PURE__*/jsx(Label, {
      transform: animatedStartY.to(value => `translate(${x}px, ${value - Y_AXIS_LABEL_VERTICAL_OFFSET}px)`),
      label: formattedYValue,
      labelWidth: barWidth,
      size: "large",
      color: axisLabelColor
    }), /*#__PURE__*/jsx(Label, {
      backgroundColor: backgroundColor,
      label: percentLabel,
      labelWidth: barWidth,
      labelHelper: labelHelper,
      transform: animatedNextY.to(value => `translate(${Number(x) + Number(barWidth)}px, ${value - PERCENT_LABEL_VERTICAL_OFFSET}px)`),
      size: "small",
      color: changeColorOpacity(axisLabelColor, 0.7)
    })]
  });
}

export { FunnelSegment };
