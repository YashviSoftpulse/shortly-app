import { useMemo } from 'react';
import { uniqueId, useAriaLabel, COLOR_VISION_SINGLE_ITEM } from '@shopify/polaris-viz-core';
import { animated } from '@react-spring/web';
import { ChartElements } from '../ChartElements/index.esnext';
import { getLongestTrendIndicator } from './utilities.esnext';
import { jsxs, jsx } from 'react/jsx-runtime';
import { useColorVisionEvents } from '../../hooks/ColorVisionA11y/useColorVisionEvents.esnext';
import { useHorizontalSeriesColors } from '../../hooks/useHorizontalSeriesColors.esnext';
import { useLegend } from '../LegendContainer/hooks/useLegend.esnext';
import { useDataForHorizontalChart } from '../../hooks/useDataForHorizontalChart.esnext';
import { useHorizontalStackedValues } from '../../hooks/useHorizontalStackedValues.esnext';
import { useHorizontalXScale } from '../../hooks/useHorizontalXScale.esnext';
import { useHorizontalBarSizes } from '../../hooks/useHorizontalBarSizes.esnext';
import { useHorizontalTransitions } from '../../hooks/useHorizontalTransitions.esnext';
import { getContainerAlignmentForLegend } from '../../utilities/getContainerAlignmentForLegend.esnext';
import { GradientDefs } from '../shared/GradientDefs/GradientDefs.esnext';
import { HorizontalGroup } from '../shared/HorizontalGroup/HorizontalGroup.esnext';
import { LegendContainer } from '../LegendContainer/LegendContainer.esnext';

function Chart({
  data,
  dimensions,
  renderLegendContent,
  legendPosition = 'bottom-right',
  seriesNameFormatter,
  showLegend,
  type,
  xAxisOptions,
  yAxisOptions
}) {
  useColorVisionEvents({
    enabled: data.length > 1
  });
  const id = useMemo(() => uniqueId('SimpleBarChart'), []);
  const {
    labelFormatter
  } = xAxisOptions;
  const isStacked = type === 'stacked';
  const {
    longestSeriesCount,
    seriesColors
  } = useHorizontalSeriesColors(data);
  const {
    legend,
    setLegendDimensions,
    height,
    width
  } = useLegend({
    data: [{
      shape: 'Bar',
      series: data
    }],
    dimensions,
    colors: seriesColors,
    showLegend,
    seriesNameFormatter
  });
  const {
    allNumbers,
    longestLabel,
    highestPositive,
    lowestNegative,
    areAllNegative
  } = useDataForHorizontalChart({
    data,
    isSimple: true,
    isStacked,
    labelFormatter
  });
  const {
    stackedValues,
    stackedMin,
    stackedMax
  } = useHorizontalStackedValues({
    isStacked,
    data
  });
  const longestTrendIndicator = getLongestTrendIndicator(data, highestPositive, lowestNegative);
  const trendIndicatorOffset = longestTrendIndicator.positive + longestTrendIndicator.negative;
  const {
    xScale
  } = useHorizontalXScale({
    allNumbers,
    isStacked,
    labelFormatter,
    maxWidth: width - trendIndicatorOffset,
    stackedMax,
    stackedMin,
    longestLabel
  });
  const {
    barHeight,
    groupHeight
  } = useHorizontalBarSizes({
    chartDimensions: {
      width,
      height
    },
    isSimple: true,
    isStacked,
    seriesLength: longestSeriesCount,
    singleBarCount: data.length,
    xAxisHeight: 0
  });
  const {
    transitions
  } = useHorizontalTransitions({
    series: data,
    groupHeight,
    chartXPosition: 0
  });
  const zeroPosition = xScale(0) + longestLabel.negative + longestTrendIndicator.negative;
  const getAriaLabel = useAriaLabel(data, {
    xAxisLabelFormatter: labelFormatter
  });
  const containerStyle = getContainerAlignmentForLegend(legendPosition, true);
  return /*#__PURE__*/jsxs(ChartElements.Div, {
    style: containerStyle,
    width: "auto",
    height: "auto",
    children: [/*#__PURE__*/jsxs(ChartElements.Svg, {
      height: height,
      width: width,
      children: [/*#__PURE__*/jsx(GradientDefs, {
        direction: "horizontal",
        gradientUnits: isStacked ? 'objectBoundingBox' : 'userSpaceOnUse',
        id: id,
        seriesColors: seriesColors,
        size: isStacked ? '100%' : `${width}px`
      }), transitions((style, item, _transition, index) => {
        var _item$key, _data$0$data$item$ind;

        const {
          opacity,
          transform
        } = style;
        const name = (_item$key = item.key) !== null && _item$key !== void 0 ? _item$key : '';
        const ariaLabel = getAriaLabel({
          seriesIndex: item.index,
          key: (_data$0$data$item$ind = data[0].data[item.index]) === null || _data$0$data$item$ind === void 0 ? void 0 : _data$0$data$item$ind.key
        });
        return /*#__PURE__*/jsx(animated.g, {
          style: {
            opacity,
            transform
          },
          children: /*#__PURE__*/jsx(HorizontalGroup, {
            areAllNegative: areAllNegative,
            ariaLabel: ariaLabel,
            barHeight: barHeight,
            containerWidth: width,
            data: data,
            groupHeight: groupHeight,
            id: id,
            index: index,
            isSimple: true,
            isStacked: isStacked,
            name: name,
            stackedValues: stackedValues,
            xAxisOptions: xAxisOptions,
            xScale: xScale,
            yAxisOptions: yAxisOptions,
            zeroPosition: zeroPosition
          })
        }, `group-${name}`);
      })]
    }), showLegend && /*#__PURE__*/jsx(LegendContainer, {
      colorVisionType: COLOR_VISION_SINGLE_ITEM,
      data: legend,
      onDimensionChange: setLegendDimensions,
      renderLegendContent: renderLegendContent,
      position: legendPosition
    })]
  });
}

export { Chart };
