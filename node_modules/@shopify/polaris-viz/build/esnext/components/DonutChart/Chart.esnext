import { useState, Fragment } from 'react';
import { pie } from 'd3-shape';
import { useChartContext, useUniqueId, useTheme, clamp, getSeriesColors, COLOR_VISION_SINGLE_ITEM, ChartState, THIN_ARC_CORNER_THICKNESS } from '@shopify/polaris-viz-core';
import { getAnimationDelayForItems } from '../../utilities/getAnimationDelayForItems.esnext';
import styles from './DonutChart.scss.esnext';
import { jsxs, jsx } from 'react/jsx-runtime';
import { useLegend } from '../LegendContainer/hooks/useLegend.esnext';
import { useColorVisionEvents } from '../../hooks/ColorVisionA11y/useColorVisionEvents.esnext';
import { useWatchColorVisionEvents } from '../../hooks/ColorVisionA11y/useWatchColorVisionEvents.esnext';
import { getContainerAlignmentForLegend } from '../../utilities/getContainerAlignmentForLegend.esnext';
import { Arc } from '../Arc/Arc.esnext';
import { InnerValue } from './components/InnerValue/InnerValue.esnext';
import { ChartSkeleton } from '../ChartSkeleton/ChartSkeleton.esnext';
import { LegendContainer } from '../LegendContainer/LegendContainer.esnext';
import { LegendValues } from './components/LegendValues/LegendValues.esnext';

const FULL_CIRCLE = Math.PI * 2;
const RADIUS_PADDING = 20;
const SMALL_CHART_HEIGHT_THRESHOLD = 150;
function Chart({
  data,
  labelFormatter,
  legendPosition = 'right',
  showLegend,
  showLegendValues,
  state,
  theme,
  accessibilityLabel = '',
  comparisonMetric,
  dimensions = {
    height: 0,
    width: 0
  },
  errorText,
  legendFullWidth = false,
  renderInnerValueContent,
  renderLegendContent,
  renderHiddenLegendLabel,
  seriesNameFormatter,
  total
}) {
  var _points$activeIndex;

  const {
    shouldAnimate
  } = useChartContext();
  const chartId = useUniqueId('Donut');
  const [activeIndex, setActiveIndex] = useState(-1);
  const selectedTheme = useTheme();
  const seriesCount = clamp({
    amount: data.length,
    min: 1,
    max: Infinity
  });
  const seriesColor = getSeriesColors(seriesCount, selectedTheme);
  const legendDirection = legendPosition === 'right' || legendPosition === 'left' ? 'vertical' : 'horizontal';
  const maxLegendWidth = legendDirection === 'vertical' ? dimensions.width / 2 : 0;
  const {
    height,
    width,
    legend,
    setLegendDimensions,
    isLegendMounted
  } = useLegend({
    data: [{
      series: data,
      shape: 'Bar'
    }],
    dimensions,
    showLegend,
    direction: legendDirection,
    colors: seriesColor,
    maxWidth: maxLegendWidth,
    seriesNameFormatter
  });
  const shouldUseColorVisionEvents = Boolean(width && height && isLegendMounted);
  useColorVisionEvents({
    enabled: shouldUseColorVisionEvents,
    dimensions: { ...dimensions,
      x: 0,
      y: 0
    }
  });
  useWatchColorVisionEvents({
    type: COLOR_VISION_SINGLE_ITEM,
    onIndexChange: ({
      detail
    }) => {
      setActiveIndex(detail.index);
    }
  });

  if (!width || !height) {
    return null;
  }

  const diameter = Math.min(height, width);
  const radius = diameter / 2;
  const dynamicThickness = height / 10;
  const maxThickness = selectedTheme.arc.thickness;
  const thickness = height > SMALL_CHART_HEIGHT_THRESHOLD ? Math.min(dynamicThickness, maxThickness) : THIN_ARC_CORNER_THICKNESS;
  const points = data.reduce((prev, {
    data
  }) => prev.concat(data), []);
  const createPie = pie().value(({
    value
  }) => value).sort(null);
  const pieChartData = createPie(points);
  const isEveryValueZero = points.every(({
    value
  }) => value === 0);
  const emptyState = pieChartData.length === 0 || isEveryValueZero;
  const totalValue = total || points.reduce((acc, {
    value
  }) => (value !== null && value !== void 0 ? value : 0) + acc, 0);
  const activeValue = (_points$activeIndex = points[activeIndex]) === null || _points$activeIndex === void 0 ? void 0 : _points$activeIndex.value;
  const minX = -40;
  const minY = -40;
  const viewBoxDimensions = {
    height: diameter + RADIUS_PADDING,
    width: diameter + RADIUS_PADDING
  };
  const containerAlignmentStyle = getContainerAlignmentForLegend(legendPosition);
  const dynamicStyles = { ...containerAlignmentStyle,
    gap: legendDirection === 'vertical' ? '16px' : undefined
  };

  const renderLegendContentWithValues = ({
    getColorVisionStyles,
    getColorVisionEventAttrs
  }) => {
    return /*#__PURE__*/jsx(LegendValues, {
      data: data,
      activeIndex: activeIndex,
      dimensions: { ...dimensions,
        x: 0,
        y: 0
      },
      legendFullWidth: legendFullWidth,
      labelFormatter: labelFormatter,
      getColorVisionStyles: getColorVisionStyles,
      getColorVisionEventAttrs: getColorVisionEventAttrs,
      renderHiddenLegendLabel: renderHiddenLegendLabel,
      seriesNameFormatter: seriesNameFormatter
    });
  };

  const shouldRenderLegendContentWithValues = !renderLegendContent && showLegendValues && legendDirection === 'vertical';
  const isCornerPosition = legendPosition.includes('-');
  return /*#__PURE__*/jsxs("div", {
    className: styles.DonutWrapper,
    style: dynamicStyles,
    children: [/*#__PURE__*/jsx("div", {
      className: styles.Donut,
      children: state === ChartState.Success ? /*#__PURE__*/jsxs(Fragment, {
        children: [/*#__PURE__*/jsx("span", {
          className: styles.VisuallyHidden,
          children: accessibilityLabel
        }), /*#__PURE__*/jsx("svg", {
          viewBox: `${minX} ${minY} ${viewBoxDimensions.width} ${viewBoxDimensions.height}`,
          height: diameter,
          width: diameter,
          children: isLegendMounted && /*#__PURE__*/jsx("g", {
            className: styles.DonutChart,
            children: emptyState ? /*#__PURE__*/jsx("g", {
              "aria-hidden": true,
              children: /*#__PURE__*/jsx(Arc, {
                isAnimated: shouldAnimate,
                width: diameter,
                height: diameter,
                radius: radius,
                startAngle: 0,
                endAngle: FULL_CIRCLE,
                color: selectedTheme.grid.color,
                cornerRadius: selectedTheme.arc.cornerRadius,
                thickness: thickness
              })
            }) : pieChartData.map(({
              data: pieData,
              startAngle,
              endAngle
            }, index) => {
              var _data$index$color, _data$index;

              const color = (_data$index$color = (_data$index = data[index]) === null || _data$index === void 0 ? void 0 : _data$index.color) !== null && _data$index$color !== void 0 ? _data$index$color : seriesColor[index];
              const name = data[index].name;
              const accessibilityLabel = `${name}: ${pieData.key} - ${pieData.value}`;
              return /*#__PURE__*/jsx("g", {
                className: styles.DonutChart,
                "aria-label": accessibilityLabel,
                role: "img",
                children: /*#__PURE__*/jsx(Arc, {
                  isAnimated: shouldAnimate,
                  animationDelay: getAnimationDelayForItems(pieChartData.length),
                  index: index,
                  activeIndex: activeIndex,
                  width: diameter,
                  height: diameter,
                  radius: radius,
                  startAngle: startAngle,
                  endAngle: endAngle,
                  color: color,
                  cornerRadius: selectedTheme.arc.cornerRadius,
                  thickness: thickness
                })
              }, `${chartId}-arc-${index}`);
            })
          })
        }), /*#__PURE__*/jsx(InnerValue, {
          activeValue: activeValue,
          activeIndex: activeIndex,
          isAnimated: shouldAnimate,
          totalValue: totalValue,
          comparisonMetric: comparisonMetric,
          labelFormatter: labelFormatter,
          renderInnerValueContent: renderInnerValueContent,
          diameter: diameter,
          dimensions: dimensions
        })]
      }) : /*#__PURE__*/jsx(ChartSkeleton, {
        dimensions: {
          width: diameter,
          height: diameter
        },
        state: state,
        type: "Donut",
        errorText: errorText,
        theme: theme
      })
    }), showLegend && /*#__PURE__*/jsx(LegendContainer, {
      fullWidth: legendFullWidth,
      onDimensionChange: setLegendDimensions,
      colorVisionType: COLOR_VISION_SINGLE_ITEM,
      data: legend,
      direction: legendDirection,
      position: legendPosition,
      maxWidth: maxLegendWidth,
      enableHideOverflow: !isCornerPosition,
      dimensions: { ...dimensions,
        x: 0,
        y: 0
      },
      renderLegendContent: shouldRenderLegendContentWithValues ? renderLegendContentWithValues : renderLegendContent
    })]
  });
}

export { Chart };
