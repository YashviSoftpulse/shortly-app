import { useCallback } from 'react';
import { useChartContext } from '@shopify/polaris-viz-core';
import { flattenDataGroupToDataSeries } from '../../../utilities/flattenDataGroupToDataSeries.esnext';
import { getYAxisOptionsWithDefaults } from '../../../utilities/getAxisOptions.esnext';

function useComboChartTooltipContent({
  data,
  renderTooltipContent,
  seriesColors,
  seriesNameFormatter
}) {
  const {
    theme
  } = useChartContext();
  return useCallback(activeIndex => {
    if (activeIndex === -1) {
      return null;
    }

    const tooltipData = [];
    let index = 0;
    data.forEach(({
      shape,
      name,
      series,
      yAxisOptions
    }) => {
      const yAxisOptionsWithDefaults = getYAxisOptionsWithDefaults(yAxisOptions);
      const data = {
        shape,
        name,
        data: []
      };
      series.forEach(({
        name,
        data: seriesData,
        color,
        isComparison
      }) => {
        const {
          value
        } = seriesData[activeIndex];
        data.data.push({
          key: `${seriesNameFormatter(name !== null && name !== void 0 ? name : '')}`,
          value: yAxisOptionsWithDefaults.labelFormatter(value),
          color: color !== null && color !== void 0 ? color : seriesColors[index],
          isComparison
        });
        index++;
      });
      tooltipData.push(data);
    });
    return renderTooltipContent({
      data: tooltipData,
      activeIndex,
      title: `${data[0].series[0].data[activeIndex].key}`,
      dataSeries: flattenDataGroupToDataSeries(data),
      theme
    });
  }, [data, seriesColors, renderTooltipContent, theme, seriesNameFormatter]);
}

export { useComboChartTooltipContent };
