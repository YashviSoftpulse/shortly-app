import { useMemo } from 'react';
import { stackOrderNone, stackOffsetDiverging } from 'd3-shape';
import { getStackedValues } from '../utilities/getStackedValues.esnext';
import { getStackedMinMax } from '../utilities/getStackedMinMax.esnext';

function useHorizontalStackedValues({
  data,
  isStacked
}) {
  const {
    stackedValues,
    stackedMin,
    stackedMax
  } = useMemo(() => {
    if (!isStacked || data.length === 0) {
      return {
        stackedMin: 0,
        stackedMax: 0,
        labels: [],
        stackedValues: []
      };
    }

    const longestSeries = data.reduce((prev, cur) => {
      if (cur.data.length > prev.data.length) {
        return cur;
      }

      return prev;
    }, data[0]);
    const labels = longestSeries.data.map(({
      key
    }) => `${key}`);
    const stackedValues = getStackedValues({
      series: data,
      labels,
      order: stackOrderNone,
      offset: stackOffsetDiverging
    });
    const {
      min,
      max
    } = getStackedMinMax({
      stackedValues,
      data,
      integersOnly: false
    });
    const formattedStackedValues = labels.map((_, labelIndex) => {
      return stackedValues.map(data => {
        return data[labelIndex];
      });
    });
    return {
      stackedMin: min,
      stackedMax: max,
      labels,
      stackedValues: formattedStackedValues
    };
  }, [isStacked, data]);
  return {
    stackedValues,
    stackedMin,
    stackedMax
  };
}

export { useHorizontalStackedValues };
